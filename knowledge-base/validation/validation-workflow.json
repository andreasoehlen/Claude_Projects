{
  "metadata": {
    "description": "Multi-step validation workflow for Teradata SQL query generation",
    "source": "Based on multi-agent validation research and existing mandatory_rules",
    "version": "1.0",
    "last_updated": "2025-11-17"
  },
  "pre_generation_validation": {
    "phase": "Before writing any SQL code",
    "required_checks": {
      "step_1_firewall_scan": {
        "action": "Read TERADATA_FORBIDDEN_PATTERNS.json completely",
        "verify": "Scan planned query against all F1-F14 patterns",
        "fail_action": "STOP and redesign query using sql_chunks.json patterns",
        "success": "Proceed to step 2"
      },
      "step_2_schema_validation": {
        "action": "Verify all tables exist",
        "verify": "Check every table in Databases/*.json files",
        "fail_action": "Request diagnostics or ask user for clarification",
        "success": "Proceed to step 3"
      },
      "step_3_column_validation": {
        "action": "Verify all columns exist in their tables",
        "verify": "Check each table's 'cols' object in Databases/*.json",
        "fail_action": "Request diagnostics or search for similar column names",
        "success": "Proceed to step 4"
      },
      "step_4_join_validation": {
        "action": "Verify join column pairs exist",
        "verify": "Check both sides of JOIN ON conditions exist",
        "fail_action": "Check common_join_patterns.json for correct join pattern",
        "success": "Proceed to step 5"
      },
      "step_5_temporal_validation": {
        "action": "Check temporal join requirements",
        "verify": "If both tables have SNPST_DT, ensure it's in join condition",
        "fail_action": "Add SNPST_DT to join: AND t1.SNPST_DT = t2.SNPST_DT",
        "success": "Proceed to generation"
      }
    }
  },
  "post_generation_validation": {
    "phase": "After SQL query is generated",
    "required_checks": {
      "syntax_check": {
        "action": "Scan generated SQL against forbidden patterns",
        "verify": [
          "No window functions in subqueries",
          "All expressions have AS aliases",
          "No reserved words as aliases",
          "No EXTRACT(DOW/QUARTER/WEEK)",
          "No WITH RECURSIVE or nested WITH",
          "No CTE self-references"
        ],
        "fail_action": "Rewrite violating section using correct pattern",
        "success": "Proceed to completeness check"
      },
      "completeness_check": {
        "action": "Verify query completeness",
        "verify": [
          "All SELECT columns have AS aliases in CTEs",
          "All non-aggregated columns in GROUP BY",
          "All ORDER BY after UNION use positions not names",
          "All SELECT statements have FROM clause",
          "All temporal tables filtered by SNPST_DT"
        ],
        "fail_action": "Add missing components",
        "success": "Proceed to optimization check"
      },
      "optimization_check": {
        "action": "Check for optimization opportunities",
        "verify": [
          "QUALIFY used instead of ROW_NUMBER subquery",
          "UNION ALL used instead of UNION where appropriate",
          "No unnecessary CAST operations",
          "LDB_ID = 1600 filter before QUALIFY for operational data"
        ],
        "fail_action": "Apply optimizations",
        "success": "Query ready for user"
      }
    }
  },
  "execution_validation": {
    "phase": "If query fails during execution",
    "workflow": {
      "step_1_capture_error": {
        "action": "Capture full error message and error code",
        "next": "step_2_classify_error"
      },
      "step_2_classify_error": {
        "action": "Look up error in error_taxonomy.json",
        "next": "step_3_apply_correction"
      },
      "step_3_apply_correction": {
        "action": "Apply correction strategy from taxonomy",
        "verify": "Check if correction resolves root cause",
        "next": "step_4_revalidate"
      },
      "step_4_revalidate": {
        "action": "Run through post_generation_validation again",
        "success": "Return corrected query to user",
        "failure": "Proceed to step_5_diagnostic_exploration"
      },
      "step_5_diagnostic_exploration": {
        "action": "Request diagnostic queries to understand issue",
        "templates": "Use diagnostic_templates.json",
        "next": "Regenerate query with diagnostic insights"
      }
    },
    "max_correction_iterations": 3,
    "escalation": "After 3 failed corrections, explain issue to user and request clarification"
  },
  "validation_checklist": {
    "before_showing_query_to_user": [
      "✓ All tables verified in Databases/*.json",
      "✓ All columns verified in table schemas",
      "✓ All JOIN columns verified in both tables",
      "✓ All temporal joins include SNPST_DT",
      "✓ No forbidden patterns present",
      "✓ All expressions have aliases",
      "✓ All GROUP BY columns present",
      "✓ Query follows Teradata syntax exactly"
    ]
  }
}
